# SPDX-FileCopyrightText: 2023 - 2025 NeoN authors
#
# SPDX-License-Identifier: Unlicense

stages:
- build-and-test
- benchmark

.build-and-test-neon: &build-and-test-neon-common
  stage: build-and-test
  rules:
    # Run only when triggered via API
    - if: $CI_PIPELINE_SOURCE == "trigger" && $BENCHMARK != "true"
      when: always
    # Skip in all other cases
    - when: never

  before_script:
    # Install pre-commit
    - pip3 install --user --break-system-packages pre-commit
    - export PATH="$HOME/.local/bin:$PATH"

    # Optional: show versions of tools
    - cmake --version
    - clang++ --version || g++ --version

# On NVIDIA GPUs
build-and-test-neon-nvidia:
  <<: *build-and-test-neon-common
  tags: ["nvidia-h100-gpus"]
  image: greole/neon-cuda
  script:
    - nvidia-smi
    - nvcc --version

    # Configure, build, and test
    - cmake --preset develop -DCMAKE_CUDA_ARCHITECTURES=90 -DNeoN_WITH_THREADS=OFF
    - cmake --build --preset develop
    - ctest --preset develop --output-on-failure

# On AMD GPUs
build-and-test-neon-amd:
  <<: *build-and-test-neon-common
  image: chihtaw/neon-rocm:6.4.1-complete
  tags: ["amd-gpus"]
  script:
    # Set ROCm environment
    - export PATH=/opt/rocm/bin:$PATH
    - export LD_LIBRARY_PATH=/opt/rocm/lib:/opt/rocm/lib64:$LD_LIBRARY_PATH

    # Set host compiler for hipcc (default is Clang bundled in ROCm)
    - export HIPCC_CXX=/usr/bin/g++

    # Configure, build, and test
    - |
      cmake --preset develop \
        -DCMAKE_C_COMPILER=gcc \
        -DCMAKE_CXX_COMPILER=hipcc \
        -DCMAKE_HIP_ARCHITECTURES=gfx90a \
        -DKokkos_ARCH_AMD_GFX90A=ON \
        -DNeoN_WITH_THREADS=OFF

    - cmake --build --preset develop
    - ctest --preset develop --output-on-failure

benchmark-neon-on-gpu:
  tags: ["nvidia-h100-gpus"]
  rules:
    # Run only when triggered via API for benchmarking
    - if: $CI_PIPELINE_SOURCE == "trigger" && $BENCHMARK == "true"
      when: always
    # Skip in all other cases
    - when: never

  variables:
    RESULTS_DIR: "benchmark-results"
    RUN_IDENTIFIER: "${CI_PIPELINE_ID}"
    REPO_NAME: "NeoFOAM-BenchmarkData"
    TARGET_REPO: "github.com/exasim-project/${REPO_NAME}.git"
    TARGET_BRANCH: "ci-benchmarks"

  before_script:
    # Install dependencies
    - pip3 install --user --break-system-packages xmltodict

    # Collect system info (CPU, GPU, compilers)
    - mkdir ${RESULTS_DIR}
    - |
      {
        echo "===== CPU INFO ====="
        lscpu
        echo ""
        echo "===== GPU INFO ====="
        nvidia-smi --query-gpu=gpu_name,memory.total,driver_version --format=csv || echo "No GPU found"
        echo ""
        echo "===== COMPILER INFO ====="
        echo "CMake:"
        cmake --version
        echo ""
        echo "C++ compiler:"
        clang++ --version || g++ --version || echo "No C++ compiler found"
        echo ""
        echo "CUDA compiler:"
        nvcc --version || echo "nvcc not available"
      } > ${RESULTS_DIR}/system-info.log

  script:
    # Build & benchmark current branch
    - echo ">>> Build current branch"
    - cmake --preset profiling -DCMAKE_CUDA_ARCHITECTURES=90 -DNeoN_WITH_THREADS=OFF
    - cmake --build --preset profiling
    - echo ">>> Running benchmarks...(current branch)"
    - ctest --preset profiling
    - cd build/profiling/bin/benchmarks
    - python3 ../../../../scripts/catch2json.py
    - cd ../../../..
    - cp build/profiling/bin/benchmarks/*.json ${RESULTS_DIR}/

    - rm -rf build

    # Build & benchmark main branch
    - echo ">>> Build main branch"
    - git fetch origin main
    - git checkout main
    - cmake --preset profiling -DCMAKE_CUDA_ARCHITECTURES=90 -DNeoN_WITH_THREADS=OFF
    - cmake --build --preset profiling
    - echo ">>> Running benchmarks...(main branch)"
    - ctest --preset profiling
    - cd build/profiling/bin/benchmarks
    - python3 ../../../../scripts/catch2json.py
    - cd ../../../..
    - mkdir -p ${RESULTS_DIR}/main
    - cp build/profiling/bin/benchmarks/*.json ${RESULTS_DIR}/main/

    # Push benchmark results to GitHub
    - git config --global user.email "gitlab-ci@users.noreply.github.com"
    - git config --global user.name "GitLab CI"
    - git clone https://oauth2:${API_TOKEN_GITHUB}@${TARGET_REPO}
    - cd ${REPO_NAME}
    - git checkout "${TARGET_BRANCH}" || git checkout -b "${TARGET_BRANCH}"
    - mkdir -p "${RUN_IDENTIFIER}/${CI_RUNNER_DESCRIPTION}"
    - cp -r ../${RESULTS_DIR}/* "${RUN_IDENTIFIER}/${CI_RUNNER_DESCRIPTION}"
    - git add .
    - git commit -m "Benchmarks from GitLab pipeline ${RUN_IDENTIFIER}" || echo "No changes to commit"
    - git pull --rebase || true
    - git push origin "${TARGET_BRANCH}"
